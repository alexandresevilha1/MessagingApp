@model MessagingApp.WebUI.Models.ChatViewModel

@{
    ViewData["Title"] = "Chat com " + Model.TargetUserName;
}

<div class="card chat-container" style="height: 80vh; display: flex; flex-direction: column;">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-person-circle"></i> Conversando com <strong>@Model.TargetUserName</strong>
    </div>

    <div class="card-body" style="flex: 1; overflow-y: auto; background-color: #f8f9fa;" id="chatBox">
        @if (!Model.Messages.Any())
        {
            <div class="text-center text-muted mt-5">
                <p>Nenhuma mensagem ainda. Diga olá!</p>
            </div>
        }
        else
        {
            <div class="d-flex flex-column">
                @foreach (var msg in Model.Messages)
                {
                    bool isMe = msg.SenderId == Model.CurrentUserId;
                    var alignment = isMe ? "align-self-end" : "align-self-start";
                    var color = isMe ? "bg-primary text-white" : "bg-white border";

                    <div class="p-2 my-1 rounded @color @alignment" style="max-width: 75%;">
                        <div>@msg.Content</div>
                        <div style="font-size: 0.7em; opacity: 0.8; text-align: right;">
                            @msg.SentAt.ToLocalTime().ToString("HH:mm")
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div class="card-footer">
        <form asp-action="SendMessage" method="post" class="d-flex gap-2" id="chatForm">
            <input type="hidden" asp-for="TargetUserId" />

            <input asp-for="NewMessageContent" class="form-control"
                   placeholder="Digite sua mensagem..." autocomplete="off" required />

            <button type="submit" class="btn btn-primary" id="sendButton">
                <i class="bi bi-send-fill"></i> Enviar
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
        "use strict";

        window.onload = function () {
            var chatBox = document.getElementById("chatBox");
            if (chatBox) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        };

        var connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        var chatBox = document.getElementById("chatBox");
        var messageInput = document.getElementById("NewMessageContent");
        var sendButton = document.getElementById("sendButton");
        var chatForm = document.getElementById("chatForm");

        if (sendButton) {
             sendButton.disabled = true;
        }

        connection.on("ReceiveMessage", function (messageDto) {

            var currentUserId = "@Model.CurrentUserId";
            var isMe = messageDto.senderId === currentUserId;

            var alignment = isMe ? "align-self-end" : "align-self-start";
            var color = isMe ? "bg-primary text-white" : "bg-white border";

            var messageElement = document.createElement("div");
            messageElement.className = "p-2 my-1 rounded " + color + " " + alignment;
            messageElement.style.maxWidth = "75%";

            var contentDiv = document.createElement("div");
            contentDiv.textContent = messageDto.content;

            var timeDiv = document.createElement("div");
            timeDiv.style.fontSize = "0.7em";
            timeDiv.style.opacity = "0.8";
            timeDiv.style.textAlign = "right";
            timeDiv.textContent = new Date(messageDto.sentAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageElement.appendChild(contentDiv);
            messageElement.appendChild(timeDiv);

            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        connection.start().then(function () {
            if (sendButton) {
                sendButton.disabled = false;
            }
        }).catch(function (err) {
            return console.error(err.toString());
        });

        if (chatForm) {
            chatForm.addEventListener("submit", function (event) {
                event.preventDefault();

                var content = messageInput.value;
                var targetUserId = "@Model.TargetUserId";

                if (content.trim() !== "") {
                    connection.invoke("SendMessage", targetUserId, content).catch(function (err) {
                        return console.error(err.toString());
                    });

                    messageInput.value = "";
                    messageInput.focus();
                }
            });
        }
    </script>
}